# JWT Verification Troubleshooting Guide

## Problem Summary

You're experiencing two JWT-related errors:

1. **SSOService Error**: `JWT verification failed: invalid signature`
   - This occurs when verifying JWT tokens from the PHP website
   - The `JWT_SECRET_KEY` in NestJS doesn't match the secret used by PHP to sign tokens

2. **AuthService Error**: `secret or public key must be provided`
   - This occurs when verifying NestJS-generated JWT tokens
   - The `JWT_SECRET` environment variable is not set or is empty

## Root Cause

Your NestJS backend uses **TWO different JWT secrets**:

1. **`JWT_SECRET`** - Used by `AuthService` to sign/verify tokens generated by NestJS
2. **`JWT_SECRET_KEY`** - Used by `SSOService` to verify tokens generated by the PHP website

**⚠️ CRITICAL**: These MUST be the same value if both PHP and NestJS use the same secret. However, based on your error, they might be:
- Not set in your `.env` file
- Different values
- Not matching the PHP website's secret

## Solution Steps

### Step 1: Verify `.env` File Location and Contents

The `.env` file should be in the `live-solution/` directory (same level as `package.json`).

Check if the file exists and contains both secrets:

```bash
cd /web/hrde/html/Live-solution  # or wherever your project is deployed
cat .env | grep JWT
```

You should see:
```
JWT_SECRET=2d99971c43e590501f81c5760eacc4cc351e590072791006a9ee3dbc064c62cf8949f2a9978f5605d1f3136f94b90356065b509a7d478e6b554a119671cfce4a
JWT_SECRET_KEY=2d99971c43e590501f81c5760eacc4cc351e590072791006a9ee3dbc064c62cf8949f2a9978f5605d1f3136f94b90356065b509a7d478e6b554a119671cfce4a
```

### Step 2: Match PHP Website's JWT Secret

**MOST IMPORTANT**: The `JWT_SECRET_KEY` in NestJS **MUST EXACTLY MATCH** the JWT secret used by your PHP website.

To find PHP's JWT secret:
1. Check PHP website's configuration file (usually in `/config/` or `.env` file)
2. Look for JWT secret configuration in PHP code

Once you find it, update your NestJS `.env`:
```bash
JWT_SECRET_KEY=<EXACT_SECRET_FROM_PHP>
```

### Step 3: Set Both Secrets Correctly

If both PHP and NestJS use the same JWT secret (which seems to be your case), set both to the same value:

```env
# Both should be the SAME value if using same JWT secret
JWT_SECRET=2d99971c43e590501f81c5760eacc4cc351e590072791006a9ee3dbc064c62cf8949f2a9978f5605d1f3136f94b90356065b509a7d478e6b554a119671cfce4a
JWT_SECRET_KEY=2d99971c43e590501f81c5760eacc4cc351e590072791006a9ee3dbc064c62cf8949f2a9978f5605d1f3136f94b90356065b509a7d478e6b554a119671cfce4a
```

### Step 4: Restart NestJS Application

After updating `.env`, restart your NestJS application:

```bash
# If using PM2
pm2 restart live-backend

# If using npm
npm run start:prod

# If using docker
docker-compose restart
```

### Step 5: Verify Configuration

The code has been updated to provide better error messages. After restarting, check the logs:

- **On startup**: Look for `✅ SSO Service initialized with JWT_SECRET_KEY`
- **On SSO login**: If signature fails, you'll see detailed error messages including:
  - Current `JWT_SECRET_KEY` length
  - Warning about mismatch with PHP website

## Code Changes Made

1. **Enhanced `auth.module.ts`**: Added validation to ensure `JWT_SECRET` is set on startup
2. **Enhanced `signaling.module.ts`**: Added validation to ensure `JWT_SECRET` is set
3. **Enhanced `sso.service.ts`**: Added detailed error logging for signature mismatches

## Testing

After fixing the configuration:

1. **Test SSO Login**: Try logging in via SSO endpoint
   ```graphql
   mutation {
     ssoLogin(input: { token: "YOUR_PHP_JWT_TOKEN" }) {
       success
       token
       user {
         email
         displayName
       }
     }
   }
   ```

2. **Test Regular Auth**: Try using a NestJS-generated token with protected endpoints

3. **Check Logs**: Verify no more JWT errors in the logs

## Common Issues

### Issue: "secret or public key must be provided"
- **Cause**: `JWT_SECRET` is not set in `.env`
- **Fix**: Add `JWT_SECRET=...` to your `.env` file

### Issue: "invalid signature" in SSO
- **Cause**: `JWT_SECRET_KEY` doesn't match PHP's secret
- **Fix**: Copy the exact secret from PHP configuration to `JWT_SECRET_KEY` in NestJS `.env`

### Issue: Environment variable not loading
- **Cause**: `.env` file in wrong location or ConfigModule not loading it
- **Fix**: Ensure `.env` is in `live-solution/` directory (same as `package.json`)
- **Verify**: Check `app.module.ts` has `ConfigModule.forRoot({ envFilePath: '.env' })`

## Next Steps

1. ✅ Update `.env` file with correct secrets
2. ✅ Restart NestJS application
3. ✅ Test SSO login
4. ✅ Monitor logs for any remaining issues

If issues persist, compare the actual JWT secret being used by PHP with the one configured in NestJS - they must be **EXACTLY** the same (including any whitespace, newlines, etc.).

